<!-- src/views/admin/CategoryManage.vue -->
<template>
  <div class="admin-layout">
    <!-- SIDEBAR -->
    <AdminSidebar />

    <!-- CONTENT -->
    <div class="admin-content">
      <main class="page">
        <!-- HEADER: tiêu đề + nút tạo -->
        <div class="header-band">
          <div class="page-head">
            <h2 class="page-title">Quản lý danh mục</h2>
            <button
              type="button"
              class="btn btn--primary"
              @click="handleCreate"
            >
              + Tạo danh mục
            </button>
          </div>

          <!-- HÀNG 2: Tìm kiếm -->
          <div class="search-row">
            <div class="search-group">
              <div class="search">
                <span class="search__icon">
                  <svg viewBox="0 0 24 24">
                    <circle
                      cx="11"
                      cy="11"
                      r="7"
                      stroke="currentColor"
                      stroke-width="1.4"
                      fill="none"
                    />
                    <line
                      x1="16"
                      y1="16"
                      x2="21"
                      y2="21"
                      stroke="currentColor"
                      stroke-width="1.4"
                    />
                  </svg>
                </span>
                <input
                  v-model.trim="keyword"
                  type="text"
                  class="search__input"
                  placeholder="Tìm kiếm danh mục..."
                />
              </div>
            </div>
          </div>
        </div>

        <!-- STATE -->
        <p v-if="loading" class="state">Đang tải danh mục…</p>
        <p v-else-if="errorMessage" class="state state--error">
          {{ errorMessage }}
        </p>

        <!-- BẢNG DANH MỤC -->
        <div v-else class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="col-name">Tên</th>
                <th>Ngày tạo</th>
                <th>Tổng sản phẩm</th>
                <th class="col-actions"></th>
              </tr>
            </thead>

            <tbody>
              <tr v-if="!filteredCategories.length">
                <td colspan="4" class="empty">
                  Không có danh mục nào.
                </td>
              </tr>

              <tr
                v-for="item in filteredCategories"
                :key="item.id"
              >
                <td class="col-name">
                  <span class="name-text">{{ item.name }}</span>
                </td>
                <td>{{ formatDate(item.createdAt) }}</td>
                <td>{{ item.productCount ?? item.totalProducts ?? 0 }}</td>
                <td class="col-actions">
                  <div class="cell-right">
                    <!-- Thêm sản phẩm vào danh mục -->
                    <button
                      type="button"
                      class="icon-btn icon-btn--primary"
                      title="Thêm sản phẩm"
                      @click="handleAddProduct(item)"
                    >
                      <svg width="30" height="30" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.5 4.375C24.7487 4.375 30.625 10.2513 30.625 17.5C30.625 24.7487 24.7487 30.625 17.5 30.625C10.2513 30.625 4.375 24.7487 4.375 17.5C4.375 10.2513 10.2513 4.375 17.5 4.375ZM16.5 16.5H10.208V18.5H16.5V24.792H18.5V18.5H24.791V16.5H18.5V10.209H16.5V16.5Z" fill="#4C80E6"/>
                    </svg>

                    </button>

                    <!-- Sửa -->
                    <button
                      type="button"
                      class="icon-btn"
                      title="Chỉnh sửa"
                      @click="handleEdit(item)"
                    >
                      <svg width="20" height="20" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.008 5.5791C12.2835 7.58857 13.9987 9.29262 16.0314 10.5557L7.02264 19.5654C6.5977 19.9904 6.38527 20.2031 6.12421 20.3428C5.86314 20.4825 5.56806 20.5413 4.9787 20.6592L0.652527 21.5244C0.320203 21.5909 0.153427 21.6246 0.0587769 21.5303C-0.0358214 21.4357 -0.00284862 21.2691 0.0636597 20.9365L0.928894 16.6094C1.04678 16.0199 1.10557 15.725 1.2453 15.4639C1.38502 15.2028 1.59774 14.9903 2.02264 14.5654L11.008 5.5791ZM17.0539 0.0332031C17.2937 -0.0110245 17.5397 -0.0110245 17.7795 0.0332031C18.3911 0.146009 18.8993 0.654983 19.9162 1.67188H19.9172C20.9341 2.68877 21.4421 3.19797 21.5549 3.80957C21.599 4.04913 21.599 4.29462 21.5549 4.53418C21.4421 5.14583 20.9333 5.65482 19.9162 6.67188L17.4894 9.09766C15.4059 7.89891 13.6749 6.18278 12.4611 4.12598L14.9162 1.67188C15.9333 0.654818 16.4422 0.146018 17.0539 0.0332031Z" fill="#838383"/>
                    </svg>

                    </button>

                    <!-- Xoá -->
                    <button
                      type="button"
                      class="icon-btn icon-btn--danger"
                      title="Xoá"
                      @click="handleDelete(item)"
                    >
                    <svg width="30" height="30" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <mask id="path-1-inside-1_2650_2610" fill="white">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.75 7.29232C8.55661 7.29232 8.37115 7.36914 8.2344 7.50589C8.09766 7.64263 8.02083 7.8281 8.02083 8.02148V9.47982C8.02083 9.6722 8.09685 9.85679 8.23233 9.99336C8.36782 10.1299 8.55179 10.2074 8.74417 10.209H26.2558C26.4482 10.2074 26.6322 10.1299 26.7677 9.99336C26.9032 9.85679 26.9792 9.6722 26.9792 9.47982V8.02148C26.9792 7.8281 26.9023 7.64263 26.7656 7.50589C26.6289 7.36914 26.4434 7.29232 26.25 7.29232H8.75ZM6.5625 9.47982C6.56242 9.94197 6.70872 10.3923 6.98041 10.7661C7.25209 11.14 7.63521 11.4182 8.07479 11.5609L8.34896 14.584H7.29167C7.09828 14.584 6.91281 14.6608 6.77607 14.7976C6.63932 14.9343 6.5625 15.1198 6.5625 15.3132C6.5625 15.5065 6.63932 15.692 6.77607 15.8287C6.91281 15.9655 7.09828 16.0423 7.29167 16.0423H8.48167L9.43396 26.5146C9.49981 27.2393 9.83416 27.9132 10.3714 28.404C10.9086 28.8948 11.6098 29.167 12.3375 29.1673H22.6596C23.3875 29.1674 24.0891 28.8953 24.6266 28.4044C25.1642 27.9136 25.4987 27.2395 25.5646 26.5146L26.5183 16.0423H27.7083C27.9017 16.0423 28.0872 15.9655 28.2239 15.8287C28.3607 15.692 28.4375 15.5065 28.4375 15.3132C28.4375 15.1198 28.3607 14.9343 28.2239 14.7976C28.0872 14.6608 27.9017 14.584 27.7083 14.584H26.651L26.9252 11.5609C27.3648 11.4182 27.7479 11.14 28.0196 10.7661C28.2913 10.3923 28.4376 9.94197 28.4375 9.47982V8.02148C28.4375 7.44132 28.207 6.88492 27.7968 6.47469C27.3866 6.06445 26.8302 5.83398 26.25 5.83398H8.75C8.16984 5.83398 7.61344 6.06445 7.2032 6.47469C6.79297 6.88492 6.5625 7.44132 6.5625 8.02148V9.47982ZM10.8865 26.3819L9.54917 11.6673H25.4523L24.1135 26.3819C24.0808 26.7445 23.9136 27.0817 23.6448 27.3273C23.376 27.5728 23.0251 27.709 22.661 27.709H12.339C11.9749 27.709 11.624 27.5728 11.3552 27.3273C11.0864 27.0817 10.9192 26.7445 10.8865 26.3819ZM16.0417 15.3132C16.0417 15.1198 15.9648 14.9343 15.8281 14.7976C15.6914 14.6608 15.5059 14.584 15.3125 14.584C15.1191 14.584 14.9336 14.6608 14.7969 14.7976C14.6602 14.9343 14.5833 15.1198 14.5833 15.3132V24.0632C14.5833 24.2565 14.6602 24.442 14.7969 24.5787C14.9336 24.7155 15.1191 24.7923 15.3125 24.7923C15.5059 24.7923 15.6914 24.7155 15.8281 24.5787C15.9648 24.442 16.0417 24.2565 16.0417 24.0632V15.3132ZM20.4167 15.3132C20.4167 15.1198 20.3398 14.9343 20.2031 14.7976C20.0664 14.6608 19.8809 14.584 19.6875 14.584C19.4941 14.584 19.3086 14.6608 19.1719 14.7976C19.0352 14.9343 18.9583 15.1198 18.9583 15.3132V24.0632C18.9583 24.2565 19.0352 24.442 19.1719 24.5787C19.3086 24.7155 19.4941 24.7923 19.6875 24.7923C19.8809 24.7923 20.0664 24.7155 20.2031 24.5787C20.3398 24.442 20.4167 24.2565 20.4167 24.0632V15.3132Z"/>
                    </mask>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.75 7.29232C8.55661 7.29232 8.37115 7.36914 8.2344 7.50589C8.09766 7.64263 8.02083 7.8281 8.02083 8.02148V9.47982C8.02083 9.6722 8.09685 9.85679 8.23233 9.99336C8.36782 10.1299 8.55179 10.2074 8.74417 10.209H26.2558C26.4482 10.2074 26.6322 10.1299 26.7677 9.99336C26.9032 9.85679 26.9792 9.6722 26.9792 9.47982V8.02148C26.9792 7.8281 26.9023 7.64263 26.7656 7.50589C26.6289 7.36914 26.4434 7.29232 26.25 7.29232H8.75ZM6.5625 9.47982C6.56242 9.94197 6.70872 10.3923 6.98041 10.7661C7.25209 11.14 7.63521 11.4182 8.07479 11.5609L8.34896 14.584H7.29167C7.09828 14.584 6.91281 14.6608 6.77607 14.7976C6.63932 14.9343 6.5625 15.1198 6.5625 15.3132C6.5625 15.5065 6.63932 15.692 6.77607 15.8287C6.91281 15.9655 7.09828 16.0423 7.29167 16.0423H8.48167L9.43396 26.5146C9.49981 27.2393 9.83416 27.9132 10.3714 28.404C10.9086 28.8948 11.6098 29.167 12.3375 29.1673H22.6596C23.3875 29.1674 24.0891 28.8953 24.6266 28.4044C25.1642 27.9136 25.4987 27.2395 25.5646 26.5146L26.5183 16.0423H27.7083C27.9017 16.0423 28.0872 15.9655 28.2239 15.8287C28.3607 15.692 28.4375 15.5065 28.4375 15.3132C28.4375 15.1198 28.3607 14.9343 28.2239 14.7976C28.0872 14.6608 27.9017 14.584 27.7083 14.584H26.651L26.9252 11.5609C27.3648 11.4182 27.7479 11.14 28.0196 10.7661C28.2913 10.3923 28.4376 9.94197 28.4375 9.47982V8.02148C28.4375 7.44132 28.207 6.88492 27.7968 6.47469C27.3866 6.06445 26.8302 5.83398 26.25 5.83398H8.75C8.16984 5.83398 7.61344 6.06445 7.2032 6.47469C6.79297 6.88492 6.5625 7.44132 6.5625 8.02148V9.47982ZM10.8865 26.3819L9.54917 11.6673H25.4523L24.1135 26.3819C24.0808 26.7445 23.9136 27.0817 23.6448 27.3273C23.376 27.5728 23.0251 27.709 22.661 27.709H12.339C11.9749 27.709 11.624 27.5728 11.3552 27.3273C11.0864 27.0817 10.9192 26.7445 10.8865 26.3819ZM16.0417 15.3132C16.0417 15.1198 15.9648 14.9343 15.8281 14.7976C15.6914 14.6608 15.5059 14.584 15.3125 14.584C15.1191 14.584 14.9336 14.6608 14.7969 14.7976C14.6602 14.9343 14.5833 15.1198 14.5833 15.3132V24.0632C14.5833 24.2565 14.6602 24.442 14.7969 24.5787C14.9336 24.7155 15.1191 24.7923 15.3125 24.7923C15.5059 24.7923 15.6914 24.7155 15.8281 24.5787C15.9648 24.442 16.0417 24.2565 16.0417 24.0632V15.3132ZM20.4167 15.3132C20.4167 15.1198 20.3398 14.9343 20.2031 14.7976C20.0664 14.6608 19.8809 14.584 19.6875 14.584C19.4941 14.584 19.3086 14.6608 19.1719 14.7976C19.0352 14.9343 18.9583 15.1198 18.9583 15.3132V24.0632C18.9583 24.2565 19.0352 24.442 19.1719 24.5787C19.3086 24.7155 19.4941 24.7923 19.6875 24.7923C19.8809 24.7923 20.0664 24.7155 20.2031 24.5787C20.3398 24.442 20.4167 24.2565 20.4167 24.0632V15.3132Z" fill="#5F5F5F"/>
                    <path d="M8.02083 9.47982L11.0208 9.47991V9.47982H8.02083ZM8.74417 10.209L8.72017 13.2089L8.73217 13.209H8.74417V10.209ZM26.2558 10.209V13.209H26.2678L26.2798 13.2089L26.2558 10.209ZM26.9792 9.47982L23.9792 9.47982V9.47991L26.9792 9.47982ZM26.9792 8.02148H23.9792H26.9792ZM6.5625 9.47982L9.5625 9.48031V9.47982H6.5625ZM8.07479 11.5609L11.0625 11.2899L10.8837 9.31839L9.00079 8.70735L8.07479 11.5609ZM8.34896 14.584V17.584H11.6333L11.3367 14.313L8.34896 14.584ZM8.48167 16.0423L11.4693 15.7706L11.2212 13.0423H8.48167V16.0423ZM9.43396 26.5146L12.4216 26.2431L12.4216 26.2429L9.43396 26.5146ZM12.3375 29.1673L12.3363 32.1673H12.3375V29.1673ZM22.6596 29.1673L22.6599 26.1673H22.6596V29.1673ZM25.5646 26.5146L22.577 26.2425L22.5769 26.2431L25.5646 26.5146ZM26.5183 16.0423V13.0423H23.7791L23.5307 15.7702L26.5183 16.0423ZM26.651 14.584L23.6633 14.313L23.3667 17.584H26.651V14.584ZM26.9252 11.5609L25.9992 8.70735L24.1163 9.31839L23.9375 11.2899L26.9252 11.5609ZM28.4375 9.47982L25.4375 9.47982V9.48031L28.4375 9.47982ZM10.8865 26.3819L13.8743 26.1119L13.8741 26.1104L10.8865 26.3819ZM9.54917 11.6673V8.66732H6.26416L6.56148 11.9388L9.54917 11.6673ZM25.4523 11.6673L28.44 11.9391L28.7376 8.66732H25.4523V11.6673ZM24.1135 26.3819L21.1259 26.1101L21.1257 26.1119L24.1135 26.3819ZM22.661 27.709L22.6612 24.709H22.661V27.709ZM12.339 27.709V24.709H12.3388L12.339 27.709ZM8.75 7.29232V4.29232C7.76096 4.29232 6.81243 4.68521 6.11308 5.38457L8.2344 7.50589L10.3557 9.62721C9.92986 10.0531 9.35226 10.2923 8.75 10.2923V7.29232ZM8.2344 7.50589L6.11308 5.38457C5.41373 6.08392 5.02083 7.03245 5.02083 8.02148H8.02083H11.0208C11.0208 8.62375 10.7816 9.20134 10.3557 9.62721L8.2344 7.50589ZM8.02083 8.02148H5.02083V9.47982H8.02083H11.0208V8.02148H8.02083ZM8.02083 9.47982L5.02083 9.47972C5.0208 10.4636 5.4096 11.4076 6.10251 12.1061L8.23233 9.99336L10.3622 7.88058C10.7841 8.30593 11.0209 8.88079 11.0208 9.47991L8.02083 9.47982ZM8.23233 9.99336L6.10251 12.1061C6.79543 12.8047 7.73631 13.201 8.72017 13.2089L8.74417 10.209L8.76817 7.20908C9.36728 7.21387 9.94022 7.45524 10.3622 7.88058L8.23233 9.99336ZM8.74417 10.209V13.209H26.2558V10.209V7.20898H8.74417V10.209ZM26.2558 10.209L26.2798 13.2089C27.2637 13.201 28.2046 12.8047 28.8975 12.1061L26.7677 9.99336L24.6378 7.88058C25.0598 7.45523 25.6327 7.21387 26.2318 7.20908L26.2558 10.209ZM26.7677 9.99336L28.8975 12.1061C29.5904 11.4076 29.9792 10.4636 29.9792 9.47972L26.9792 9.47982L23.9792 9.47991C23.9791 8.88079 24.2159 8.30593 24.6378 7.88058L26.7677 9.99336ZM26.9792 9.47982H29.9792V8.02148H26.9792H23.9792V9.47982H26.9792ZM26.9792 8.02148H29.9792C29.9792 7.03245 29.5863 6.08392 28.8869 5.38457L26.7656 7.50589L24.6443 9.62721C24.2184 9.20134 23.9792 8.62374 23.9792 8.02148L26.9792 8.02148ZM26.7656 7.50589L28.8869 5.38457C28.1876 4.68521 27.239 4.29232 26.25 4.29232V7.29232V10.2923C25.6477 10.2923 25.0701 10.0531 24.6443 9.62721L26.7656 7.50589ZM26.25 7.29232V4.29232H8.75V7.29232V10.2923H26.25V7.29232ZM6.5625 9.47982L3.5625 9.47933C3.56232 10.5753 3.90925 11.6432 4.55354 12.5297L6.98041 10.7661L9.40728 9.00253C9.50819 9.1414 9.56253 9.30865 9.5625 9.48031L6.5625 9.47982ZM6.98041 10.7661L4.55354 12.5297C5.19782 13.4163 6.10635 14.0761 7.14879 14.4144L8.07479 11.5609L9.00079 8.70735C9.16406 8.76033 9.30636 8.86367 9.40728 9.00253L6.98041 10.7661ZM8.07479 11.5609L5.08705 11.8318L5.36122 14.8549L8.34896 14.584L11.3367 14.313L11.0625 11.2899L8.07479 11.5609ZM8.34896 14.584V11.584H7.29167V14.584V17.584H8.34896V14.584ZM7.29167 14.584V11.584C6.30264 11.584 5.35411 11.9769 4.65475 12.6762L6.77607 14.7976L8.89739 16.9189C8.47152 17.3447 7.89392 17.584 7.29167 17.584V14.584ZM6.77607 14.7976L4.65475 12.6762C3.95539 13.3756 3.5625 14.3241 3.5625 15.3132H6.5625H9.5625C9.5625 15.9154 9.32325 16.493 8.89739 16.9189L6.77607 14.7976ZM6.5625 15.3132H3.5625C3.5625 16.3022 3.95539 17.2507 4.65475 17.9501L6.77607 15.8287L8.89739 13.7074C9.32325 14.1333 9.5625 14.7109 9.5625 15.3132H6.5625ZM6.77607 15.8287L4.65475 17.9501C5.35411 18.6494 6.30264 19.0423 7.29167 19.0423V16.0423V13.0423C7.89392 13.0423 8.47152 13.2816 8.89739 13.7074L6.77607 15.8287ZM7.29167 16.0423V19.0423H8.48167V16.0423V13.0423H7.29167V16.0423ZM8.48167 16.0423L5.49399 16.314L6.44629 26.7863L9.43396 26.5146L12.4216 26.2429L11.4693 15.7706L8.48167 16.0423ZM9.43396 26.5146L6.44627 26.7861C6.57986 28.2561 7.25811 29.6232 8.34788 30.6188L10.3714 28.404L12.3949 26.1891C12.4102 26.2031 12.4198 26.2224 12.4216 26.2431L9.43396 26.5146ZM10.3714 28.404L8.34788 30.6188C9.43764 31.6144 10.8602 32.1667 12.3363 32.1673L12.3375 29.1673L12.3387 26.1673C12.3595 26.1673 12.3795 26.1751 12.3949 26.1891L10.3714 28.404ZM12.3375 29.1673V32.1673H22.6596V29.1673V26.1673H12.3375V29.1673ZM22.6596 29.1673L22.6593 32.1673C24.1359 32.1675 25.5592 31.6155 26.6496 30.6198L24.6266 28.4044L22.6037 26.1891C22.619 26.1751 22.6391 26.1673 22.6599 26.1673L22.6596 29.1673ZM24.6266 28.4044L26.6496 30.6198C27.74 29.6241 28.4186 28.2567 28.5523 26.7861L25.5646 26.5146L22.5769 26.2431C22.5788 26.2224 22.5883 26.2031 22.6037 26.1891L24.6266 28.4044ZM25.5646 26.5146L28.5522 26.7867L29.506 16.3144L26.5183 16.0423L23.5307 15.7702L22.577 26.2425L25.5646 26.5146ZM26.5183 16.0423V19.0423H27.7083V16.0423V13.0423H26.5183V16.0423ZM27.7083 16.0423V19.0423C28.6974 19.0423 29.6459 18.6494 30.3453 17.9501L28.2239 15.8287L26.1026 13.7074C26.5285 13.2816 27.1061 13.0423 27.7083 13.0423V16.0423ZM28.2239 15.8287L30.3453 17.9501C31.0446 17.2507 31.4375 16.3022 31.4375 15.3132H28.4375H25.4375C25.4375 14.7109 25.6767 14.1333 26.1026 13.7074L28.2239 15.8287ZM28.4375 15.3132H31.4375C31.4375 14.3241 31.0446 13.3756 30.3453 12.6762L28.2239 14.7976L26.1026 16.9189C25.6767 16.493 25.4375 15.9154 25.4375 15.3132H28.4375ZM28.2239 14.7976L30.3453 12.6762C29.6459 11.9769 28.6974 11.584 27.7083 11.584V14.584V17.584C27.1061 17.584 26.5285 17.3447 26.1026 16.9189L28.2239 14.7976ZM27.7083 14.584V11.584H26.651V14.584V17.584H27.7083V14.584ZM26.651 14.584L29.6388 14.8549L29.9129 11.8318L26.9252 11.5609L23.9375 11.2899L23.6633 14.313L26.651 14.584ZM26.9252 11.5609L27.8512 14.4144C28.8937 14.0761 29.8022 13.4163 30.4465 12.5297L28.0196 10.7661L25.5927 9.00253C25.6936 8.86367 25.8359 8.76033 25.9992 8.70735L26.9252 11.5609ZM28.0196 10.7661L30.4465 12.5297C31.0907 11.6432 31.4377 10.5753 31.4375 9.47933L28.4375 9.47982L25.4375 9.48031C25.4375 9.30865 25.4918 9.14139 25.5927 9.00253L28.0196 10.7661ZM28.4375 9.47982H31.4375V8.02148H28.4375H25.4375V9.47982H28.4375ZM28.4375 8.02148H31.4375C31.4375 6.64567 30.891 5.32621 29.9181 4.35337L27.7968 6.47469L25.6755 8.59601C25.5231 8.44364 25.4375 8.23698 25.4375 8.02148H28.4375ZM27.7968 6.47469L29.9181 4.35337C28.9453 3.38052 27.6258 2.83398 26.25 2.83398V5.83398V8.83398C26.0345 8.83398 25.8278 8.74838 25.6755 8.59601L27.7968 6.47469ZM26.25 5.83398V2.83398H8.75V5.83398V8.83398H26.25V5.83398ZM8.75 5.83398V2.83398C7.37419 2.83398 6.05473 3.38052 5.08188 4.35337L7.2032 6.47469L9.32452 8.59601C9.17215 8.74838 8.96549 8.83398 8.75 8.83398V5.83398ZM7.2032 6.47469L5.08188 4.35337C4.10904 5.32621 3.5625 6.64568 3.5625 8.02148H6.5625H9.5625C9.5625 8.23697 9.4769 8.44363 9.32452 8.59601L7.2032 6.47469ZM6.5625 8.02148H3.5625V9.47982H6.5625H9.5625V8.02148H6.5625ZM10.8865 26.3819L13.8741 26.1104L12.5369 11.3958L9.54917 11.6673L6.56148 11.9388L7.89877 26.6534L10.8865 26.3819ZM9.54917 11.6673V14.6673H25.4523V11.6673V8.66732H9.54917V11.6673ZM25.4523 11.6673L22.4646 11.3955L21.1259 26.1101L24.1135 26.3819L27.1012 26.6537L28.44 11.9391L25.4523 11.6673ZM24.1135 26.3819L21.1257 26.1119C21.1604 25.7286 21.3371 25.3721 21.6212 25.1125L23.6448 27.3273L25.6683 29.5421C26.49 28.7913 27.0012 27.7604 27.1014 26.6519L24.1135 26.3819ZM23.6448 27.3273L21.6212 25.1125C21.9054 24.8529 22.2763 24.709 22.6612 24.709L22.661 27.709L22.6609 30.709C23.7739 30.709 24.8467 30.2928 25.6683 29.5421L23.6448 27.3273ZM22.661 27.709V24.709H12.339V27.709V30.709H22.661V27.709ZM12.339 27.709L12.3388 24.709C12.7237 24.709 13.0946 24.8529 13.3788 25.1125L11.3552 27.3273L9.33166 29.5421C10.1533 30.2928 11.2261 30.709 12.3391 30.709L12.339 27.709ZM11.3552 27.3273L13.3788 25.1125C13.6629 25.3721 13.8396 25.7286 13.8743 26.1119L10.8865 26.3819L7.89863 26.6519C7.9988 27.7604 8.50997 28.7913 9.33166 29.5421L11.3552 27.3273ZM16.0417 15.3132H19.0417C19.0417 14.3241 18.6488 13.3756 17.9494 12.6762L15.8281 14.7976L13.7068 16.9189C13.2809 16.493 13.0417 15.9154 13.0417 15.3132H16.0417ZM15.8281 14.7976L17.9494 12.6762C17.2501 11.9769 16.3015 11.584 15.3125 11.584V14.584V17.584C14.7102 17.584 14.1326 17.3447 13.7068 16.9189L15.8281 14.7976ZM15.3125 14.584V11.584C14.3235 11.584 13.3749 11.9769 12.6756 12.6762L14.7969 14.7976L16.9182 16.9189C16.4924 17.3447 15.9148 17.584 15.3125 17.584V14.584ZM14.7969 14.7976L12.6756 12.6762C11.9762 13.3756 11.5833 14.3241 11.5833 15.3132H14.5833H17.5833C17.5833 15.9154 17.3441 16.493 16.9182 16.9189L14.7969 14.7976ZM14.5833 15.3132H11.5833V24.0632H14.5833H17.5833V15.3132H14.5833ZM14.5833 24.0632H11.5833C11.5833 25.0522 11.9762 26.0007 12.6756 26.7001L14.7969 24.5787L16.9182 22.4574C17.3441 22.8833 17.5833 23.4609 17.5833 24.0632H14.5833ZM14.7969 24.5787L12.6756 26.7001C13.3749 27.3994 14.3235 27.7923 15.3125 27.7923V24.7923V21.7923C15.9148 21.7923 16.4924 22.0316 16.9182 22.4574L14.7969 24.5787ZM15.3125 24.7923V27.7923C16.3015 27.7923 17.2501 27.3994 17.9494 26.7001L15.8281 24.5787L13.7068 22.4574C14.1326 22.0316 14.7102 21.7923 15.3125 21.7923V24.7923ZM15.8281 24.5787L17.9494 26.7001C18.6488 26.0007 19.0417 25.0522 19.0417 24.0632H16.0417H13.0417C13.0417 23.4609 13.2809 22.8833 13.7068 22.4574L15.8281 24.5787ZM16.0417 24.0632H19.0417V15.3132H16.0417H13.0417V24.0632H16.0417ZM20.4167 15.3132H23.4167C23.4167 14.3241 23.0238 13.3756 22.3244 12.6762L20.2031 14.7976L18.0818 16.9189C17.6559 16.493 17.4167 15.9154 17.4167 15.3132H20.4167ZM20.2031 14.7976L22.3244 12.6762C21.6251 11.9769 20.6765 11.584 19.6875 11.584V14.584V17.584C19.0852 17.584 18.5076 17.3447 18.0818 16.9189L20.2031 14.7976ZM19.6875 14.584V11.584C18.6985 11.584 17.7499 11.9769 17.0506 12.6762L19.1719 14.7976L21.2932 16.9189C20.8674 17.3447 20.2898 17.584 19.6875 17.584V14.584ZM19.1719 14.7976L17.0506 12.6762C16.3512 13.3756 15.9583 14.3241 15.9583 15.3132H18.9583H21.9583C21.9583 15.9154 21.7191 16.493 21.2932 16.9189L19.1719 14.7976ZM18.9583 15.3132H15.9583V24.0632H18.9583H21.9583V15.3132H18.9583ZM18.9583 24.0632H15.9583C15.9583 25.0522 16.3512 26.0007 17.0506 26.7001L19.1719 24.5787L21.2932 22.4574C21.7191 22.8833 21.9583 23.4609 21.9583 24.0632H18.9583ZM19.1719 24.5787L17.0506 26.7001C17.7499 27.3994 18.6985 27.7923 19.6875 27.7923V24.7923V21.7923C20.2898 21.7923 20.8674 22.0316 21.2932 22.4574L19.1719 24.5787ZM19.6875 24.7923V27.7923C20.6765 27.7923 21.6251 27.3994 22.3244 26.7001L20.2031 24.5787L18.0818 22.4574C18.5076 22.0316 19.0852 21.7923 19.6875 21.7923V24.7923ZM20.2031 24.5787L22.3244 26.7001C23.0238 26.0007 23.4167 25.0522 23.4167 24.0632H20.4167H17.4167C17.4167 23.4609 17.6559 22.8833 18.0818 22.4574L20.2031 24.5787ZM20.4167 24.0632H23.4167V15.3132H20.4167H17.4167V24.0632H20.4167Z" fill="#E60000" mask="url(#path-1-inside-1_2650_2610)"/>
                    </svg>

                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <!-- POPUPS -->
    <CategoryProductPopup
      v-model:open="showProductPopup"
      :category="currentCategory"
      @submit="handleAddProducts"
    />

    <CategoryProductRemovePopup
      v-if="currentCategory"
      v-model:open="openRemovePopup"
      :categoryId="currentCategory.id"
      @delete="removeProducts"
    />

    <!-- Popup tạo danh mục mới -->
    <CreateCategoryPopup
      :open="showCreatePopup"
      :categories="categories"
      @update:open="showCreatePopup = $event"
      @created="onCategoryCreated"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";

import AdminSidebar from "../../components/admin/AdminSidebar.vue";
import CategoryProductPopup from "../../components/admin/CategoryProductPopup.vue";
import CategoryProductRemovePopup from "../../components/admin/CategoryProductRemovePopup.vue";
import CreateCategoryPopup from "../../components/admin/CreateCategoryPopup.vue";
import { request } from "../../services/http";



const loading = ref(false);
const errorMessage = ref("");
const keyword = ref("");
const categories = ref([]);
/* popup chọn sản phẩm */
const showProductPopup = ref(false);
const currentCategory = ref(null);
const openRemovePopup = ref(false);
/* popup tạo danh mục */
const showCreatePopup = ref(false);
/* Lọc theo từ khoá */
const filteredCategories = computed(() => {
  const q = keyword.value.trim().toLowerCase();
  if (!q) return categories.value;
  return categories.value.filter((c) =>
    (c.name || "").toLowerCase().includes(q)
  );
});

function formatDate(value) {
  if (!value) return "";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("vi-VN", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}

/* GET /categories */
async function fetchCategories() {
  loading.value = true;
  errorMessage.value = "";
  try {
    const { data } = await request("/categories");
    // tuỳ backend: mảng hay { data: [...] }
    categories.value = Array.isArray(data) ? data : data.data || data.items || [];
  } catch (err) {
    console.error(err);
    errorMessage.value = "Không tải được danh mục. Vui lòng thử lại.";
  } finally {
    loading.value = false;
  }
}

/* Handler UI (sau này bạn có thể điều hướng / mở popup) */
function handleCreate() {
  showCreatePopup.value = true;
}

async function onCategoryCreated(newCategory) {
  console.log('Danh mục mới:', newCategory);
  // Reload danh sách danh mục
  await fetchCategories();
}

async function removeProducts(productIds) {
  if (!currentCategory.value || !productIds.length) {
    openRemovePopup.value = false
    return
  }

  try {
    loading.value = true
    const catId = currentCategory.value.id

    // ĐỔI URL & method cho đúng backend nếu bạn có route khác
    await request(`/categories/${catId}/products/remove`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      data: { productIds },
    })

    alert(
      `Đã xoá ${productIds.length} sản phẩm khỏi danh mục "${currentCategory.value.name}".`
    )
    await fetchCategories() // load lại tổng sản phẩm
  } catch (err) {
    console.error(err)
    alert("Xoá sản phẩm khỏi danh mục thất bại.")
  } finally {
    loading.value = false
    openRemovePopup.value = false
  }
}

function handleAddProduct(category) {
  // Lưu lại danh mục đang chọn và mở popup
  currentCategory.value = category;
  showProductPopup.value = true;
}
function handleEdit(category) {
  currentCategory.value = category
  openRemovePopup.value = true
}


/* Nhận danh sách productIds từ popup và gọi API backend
   Swagger: POST /categories/{categoryId}/products  body: { productId } */
async function handleAddProducts(productIds) {
  if (!currentCategory.value || !productIds.length) {
    showProductPopup.value = false;
    return;
  }

  try {
    loading.value = true;
    const catId = currentCategory.value.id;

    for (const productId of productIds) {
      await request(`/categories/${catId}/products`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        data: { productId },
      });
    }
    alert(
      `Đã thêm ${productIds.length} sản phẩm vào danh mục "${currentCategory.value.name}".`
    );
    await fetchCategories(); // cập nhật lại tổng sản phẩm
  } catch (err) {
    console.error(err);
    alert("Lỗi khi thêm sản phẩm vào danh mục.");
  } finally {
    loading.value = false;
    showProductPopup.value = false;
  }
}

/* DELETE /categories/{id} */
async function handleDelete(category) {
  const ok = window.confirm(`Bạn có chắc muốn xoá danh mục "${category.name}"?`);
  if (!ok) return;

  try {
    await request(`/categories/${category.id}`, { method: "DELETE" });
    categories.value = categories.value.filter((c) => c.id !== category.id);
  } catch (err) {
    console.error(err);
    alert("Xoá danh mục thất bại. Vui lòng thử lại.");
  }
}

onMounted(fetchCategories);
</script>

<style scoped>
.admin-layout {
  display: flex;
  min-height: 100vh;
  background: #f5f5f7;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Segoe UI", sans-serif;
}
.admin-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.page {
  padding: 0 32px 16px;
}

/* HEADER giống ProductManage */
.header-band {
  background: #f6f7fb;
  border-bottom: 1px solid #e9ecf3;
}
.page-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0 8px;
}
.page-title {
  font-size: 26px;
  font-weight: 700;
  color: #0f172a;
  margin: 0;
}

/* SEARCH HÀNG 2 */
.search-row {
  display: flex;
  align-items: center;
  padding-bottom: 16px;
}
.search-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.search {
  position: relative;
  width: 360px;
}
.search__icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  color: #b2b6c6;
}
.search__input {
  border: 1px solid #e3e6ef;
  height: 44px;
  width: 100%;
  padding: 0 14px 0 40px;
  border-radius: 18px;
  background: #fff;
  font-size: 14px;
  color: #111827;
}
.search__input::placeholder {
  color: #a9afc2;
}
.search__input:focus {
  border-color: #cbd2ff;
  box-shadow: 0 0 0 3px rgba(91, 108, 255, 0.12);
}

/* BUTTON */
.btn {
  height: 44px;
  padding: 0 16px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
  font-weight: 400;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn--primary {
  background: #4c80e6;
  color: #fff;
  box-shadow: 0 6px 14px rgba(63, 99, 255, 0.25);
  text-decoration: none;
}

/* TABLE giống style sản phẩm */
.table-wrap {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
  overflow: hidden;
  margin-top: 16px;
}
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 16px;
}
.table thead {
  background: #fafafa;
}
.table th,
.table td {
  padding: 14px 18px;
  text-align: left;
}
.table td{
    border-bottom: 1px solid #999999;
}
.table th {
  font-weight: 500;
  border-bottom: 1px solid #999999;
}
.table tbody tr {
  transition: background-color 0.2s ease;
}
.table tbody tr:hover {
  background-color: #f1f1f1;
}

.col-name {
  width: 40%;
}
.col-actions {
  width: 140px;
}

.name-text {
  font-weight: 500;
  color: #222;
}

/* ICON BUTTONS */
.col-actions .cell-right {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
}
.icon-btn {
  border: 0;
  background: transparent;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
}

.icon-btn--primary {
  color: #2563eb;
}
.icon-btn--danger {
  color: #ef4444;
}
.icon-btn:hover {
  background: rgba(0, 0, 0, 0.06);
}

/* STATE + EMPTY */
.state {
  margin-top: 16px;
  font-size: 14px;
  color: #4b5563;
}
.state--error {
  color: #b91c1c;
}
.empty {
  text-align: center;
  padding: 24px 16px;
  color: #6b7280;
}
</style>
